@using InterBook2._0.Views.Search.App_LocalResources;
@using System.Web.Optimization
@model InterBook2._0.Models.SearchModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@Styles.Render("~/Media/css/Search")

@*FORMULAIRE*@
<section class="container">
    <div class="form">
        @using (Html.BeginForm("Index", "Search", FormMethod.Get))
        {
            @Html.ValidationSummary(true)
            @Html.TextBoxFor(x => x.Profession, new { @class = "inputQuery", placeholder = Index.Quoi })
            @Html.TextBoxFor(x => x.Debut, new { @class = "inputQuery", id = "Date" })
            @Html.TextBoxFor(x => x.Ville, new { @class = "inputQuery", placeholder = Index.Ou })
            <input type="submit" value="" />
            <button id="lienRechercheAvancee"></button>
            @Html.ValidationMessageFor(x => x.Profession)
            @Html.ValidationMessageFor(x => x.Ville)
        }
    </div>
</section>

@*FILTRES*@
<script type="text/javascript">

    function changeFilter(vars, id)
    {
        if (vars[id] == undefined) {
            $("#" + id + " > li").each(function (i) {
                if (i != 0)
                    $(this).html("<a rel='filter' href='" + document.URL + "&" + id + "=" + i + "'>" + $("#" + id + "-" + i).html() + "</a>");
            });
        }
        else if (vars[id] != undefined) {
            $("#" + id + " > li").each(function (i) {
                if (i != vars[id])
                    $(this).html("<a rel='filter' href='" + document.URL.replace("&" + id + "=" + vars[id], "&" + id + "=" + i) + "'>" + $("#" + id + "-" + i).text() + "</a>");
                else
                    $(this).html($("#" + id + "-" + i).text());
            });
        }
    }

    function changeResults(vars) {
        var filtres = {
            ville: vars["ville"],
            debut: vars["debut"],
            fin: vars["fin"],
            profession: vars["profession"],
            experience: vars["exp"],
            contrat: vars["cont"]
        };

        $.ajax({
            type: "GET",
            url: "/Search/Filtre",
            dataType: "json",
            contentType: "application/json",
            data: filtres
            })
            .done(function (data) {
                $("#results>div").html("");

                var eArr = data.keys();

                data.forEach(function (u) {
                    $("#results>div").append("          \
                        <article id='result" + eArr.next().value + "'>                   \
                            <a href='" + location.protocol + "//" + location.hostname + (location.port ? ':' + location.port : '') + "/u/" + u["IdU"] + "'>" + u["IdU"] + "</a>           \
                            <br />                  \
                            IDU_Email : " + u["idu_Email"] + "           \
                            <br />                  \
                            Experience : " + u["Util_Experience"][0]["Ref_Experience"]["Description"] + "           \
                            <br />                  \
                            Contrat : " + u["Util_Contrat"][0]["Ref_Contrat"]["Description"] + "           \
                        </article>                  \
                        ");
                });
            })
            .fail(function () {
                console.log("error");
            })
    }

    function filter()
    {
        var vars = [], hash;
        var q = decodeURIComponent(document.URL).split('?')[1];
        if (q != undefined) {
            q = q.split('&');
            for (var i = 0; i < q.length; i++) {
                hash = q[i].split('=');
                //vars.push(hash[1]);   vars[0]
                vars[hash[0].toLowerCase()] = hash[1];  // vars["ville"]
            }
        }
        changeResults(vars);
        $("#filter > ul").each(function () {
            changeFilter(vars, this.id);
            //this.Attr("id").split("-")[0]
        });
    }

    function recur() {
        $('a[rel="filter"]').on('click', function () {
            //Recupere le lien cliqué
            pageurl = this.href;

            //Change l'url du navigateur
            if (pageurl != window.location) {
                window.history.pushState({ path: pageurl }, '', pageurl);
                filter();
                recur();
            }
            return false;
        });
        
    }

    $(function () {
        filter();
        recur();
    });
</script>

<section id="filtreResultat" class="container">

    <div id="filter" class="filter left">
        <h3><img src="~/Media/img/search/flecheHautCriteres.png" />Critères de recherce</h3>
        <span>Niveau d'expérience</span>
        <ul id="exp">
            <li id="exp-0">Tous</li>
            <li id="exp-1">Junior (0 à 1 ans)</li>
            <li id="exp-2">Expérimenté (2 à 5 ans)</li>
            <li id="exp-3">Senior (6+)</li>
        </ul>
        <span>Région</span>
        <ul id="cont">
            <li id="cont-0">Tous</li>
            <li id="cont-1">CDI</li>
            <li id="cont-2">CDD</li>
            <li id="cont-3">Stage</li>
            <li id="cont-4">Freelance</li>
        </ul>
    </div>

    @*RESULTATS*@
    <div id="results" class="results left">
        <h3>566 résultats trouvés</h3>
        <div>
            @*@foreach (var u in Model.lu)
            {
                <p>@u.IdU.ToString()</p>
                <br />
                <p>@u.idu_email.ToString()</p>
                <hr />
            }*@
        </div>
    </div>
    <div class="clear"></div>

    
    @*GOOGLE MAP
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8vsWgmO3tb8tkbOU1Gb4qkOWIiIqpVeM" type="text/javascript"></script>
    <script>
        google.maps.event.addDomListener(window, 'load', initialize);

        function initialize() {
            var geocoder = new google.maps.Geocoder();
            var addr, latitude, longitude;
            /* Récupération du champ "adresse" */
            addr = document.getElementById('Ville').value;
            /* Tentative de géocodage */
            geocoder.geocode({ 'address': addr }, function (results, status) {
                /* Si géolocalisation réussie */
                if (status == google.maps.GeocoderStatus.OK) {
                    /* Récupération des coordonnées */
                    latitude = results[0].geometry.location.lat();
                    longitude = results[0].geometry.location.lng();

                    var latlng = new google.maps.LatLng(latitude, longitude);


                    var mapOptions = {
                        center: latlng,
                        scrollWheel: false,
                        zoom: 12
                    };

                    //var marker = new google.maps.Marker({
                    //    position: latlng,
                    //    url: '/',
                    //    animation: google.maps.Animation.DROP
                    //});

                    var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
                    //marker.setMap(map);
                    
                    /*RECUPERATION DES POINTS*/
                    var beaches = [
                                    ['Paris 05', 48.8434912, 2.351833899999974, 1],
                                    ['Paris 10', 48.8785618, 2.360368900000026, 2],
                                    ['Paris 13', 48.8278352, 2.293537199999946, 3],
                                    ['Paris 16', 48.8585799, 2.284701700000028, 4],
                                    ['Paris 19', 48.88237609999999, 2.382291699999996, 5]
                    ];
                    for (var i = 0; i < beaches.length; i++) {
                        var beach = beaches[i];
                        var myLatLng = new google.maps.LatLng(beach[1], beach[2]);
                        var marker = new google.maps.Marker({
                            position: myLatLng,
                            map: map,
                            title: beach[0],
                            zIndex: beach[3]
                        });
                        google.maps.event.addListener(marker, 'click', function () {
                            $("#result"+i).css("background", "silver");
                        });
                    }

                    /* Appel AJAX pour insertion en BDD 
                    var sendAjax = $.ajax({
                        type: "POST",
                        url: 'insert-in-bdd.php',
                        data: 'lat=' + latitude + '&lng=' + longitude + '&adr=' + addr,
                        success: handleResponse
                    });*/
                }
                function handleResponse() {
                    $('#answer').get(0).innerHTML = sendAjax.responseText;
                }
            });
        };

    </script>
    <div align="center" id="map-canvas" style="width: 700px; height: 500px"><br /></div>*@
    <div id="answer"></div>
</section>
